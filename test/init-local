#!/bash

+can md2man || bpan -q install github:bpan-org/md2man

export BPAN_INSTALL=$PWD/test/local
mkdir -p "$BPAN_INSTALL"

export BPAN_TEST_INDEX_REPO=$BPAN_ROOT/local/src/github/bpan-org/bpan-index/.git
export BPAN_TEST_GITHUB_USER_ID=octocat

export GIT_AUTHOR_NAME='Pat Tester'
export GIT_AUTHOR_EMAIL=pat@tester.bpan
export GIT_COMMITTER_NAME='Pat Tester'
export GIT_COMMITTER_EMAIL=pat@tester.bpan

install-test-bpan() {
  root=$(basename "$(caller | cut -d ' ' -f2)")
  root=$PWD/test/bpan-${root%.t}

  rm -fr "$root"

  local branch
  branch=$(git config --file=Meta package.branch)

  git clone --quiet --branch="$branch" .git "$root"
  find .bpan bin etc lib share |
    cpio -dump "$root" &>/dev/null

  git -C "$root" commit -am wip >/dev/null || true

  set +eu
  source "$root/.rc" || die
  set -eu
}

test-errors() {
  while read -r cmd && read -r msg; do
    cmd=${cmd#> }
    has "$($cmd 2>&1)" "$msg" \
      "'$cmd' fails with: $msg"
  done
}
